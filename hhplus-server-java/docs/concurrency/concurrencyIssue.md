# 📝 동시성 이슈 식별 및 개선 보고서

## 1. 배경

시스템의 API가 CRUD(생성, 조회, 수정, 삭제)의 역할을 할 때  
**Create, Update, Delete(C/U/D) 연산**은  
여러 클라이언트(또는 프로세스)에서 **동시에 동일한 자원(row, entity 등)에 접근**할 수 있다.  
이 과정에서 **동시성 이슈**가 발생할 수 있다고 판단하였다.

동시성 이슈란
> **동일 데이터(자원)에 여러 트랜잭션/쓰레드가 동시에 접근 및 변경 시,  
> 데이터 정합성이 깨질 수 있는 현상**을 의미한다.

---

## 2. 이슈 식별 방법

동시성 이슈를 재현하고 식별하기 위해  
다음과 같은 방법을 사용하였다.

- **CountDownLatch 등 동기화 유틸리티를 활용해**  
  여러 쓰레드가 C/U/D API를 동시에 호출하도록 테스트 시나리오를 구성
- **테스트 실행 후, 실제 데이터가 부정합(누락, 중복, 잘못된 값 등)이 발생하는지 검증**

---

## 3. 실제 발견된 동시성 문제

실제 테스트 과정에서 아래와 같은 **핵심 자원**에서 동시성 문제가 발생함을 확인하였다.

- **잔액 충전/사용:**  
  동시에 여러 사용자가 같은 계좌에 대해 충전/사용을 시도할 때,  
  최종 잔액이 올바르지 않게 되는 문제(분실 갱신, 중복 업데이트 등)
- **쿠폰 발급(재고 차감):**  
  여러 사용자가 동시에 한정 수량 쿠폰을 발급 시도할 때,  
  쿠폰 재고가 마이너스가 되거나, 초과 발급이 발생
- **주문 취소(상품 재고 차감):**  
  동시에 여러 주문이 취소되어 동일 상품의 재고를 복구할 때,  
  재고가 실제 이상으로 늘어나거나, 누락되는 현상

---

## 4. 문제 원인

테스트 결과,
> **"한 개의 자원(row)에 여러 트랜잭션이 동시에 접근 및 갱신"** 이 발생할 경우
- **분실 갱신(lost update)**
- **중복 처리, 데이터 불일치**  
  등의 현상이 발생할 수 있음을 확인하였다.

이러한 현상의 근본 원인은
> **트랜잭션 간의 적절한 동기화 및 Lock 제어가 부족하기 때문**이었다.

---

## 5. 개선 방법

### (1) **DB Lock(락)을 이용한 동시성 제어**

동시성 이슈 해결을 위해 **DB 수준의 Lock**을 도입하였다.  
대표적으로 두 가지 방법이 있다.

- **낙관적 락(Optimistic Lock):**
    - 데이터의 버전(version) 정보를 활용해 충돌 감지
    - 충돌 시 재시도(rollback 후 재시도)
    - 장점: 병렬 처리에 유리
    - 단점: 충돌이 빈번하면 성능 저하/복잡성 증가
- **비관적 락(Pessimistic Lock):**
    - 데이터(row)에 대해 명시적으로 Lock을 걸고, 다른 트랜잭션은 해당 자원 접근 시까지 대기
    - 장점: **정합성 보장에 최우선** (동시성 문제 원천 차단)
    - 단점: TPS 하락, 병목, 데드락 위험 증가

### (2) **실제 적용 및 판단**

- 초기에 **낙관적 락**으로 개선을 시도했으나,  
  충돌 빈도가 높고, 데이터 정합성이 절대적으로 중요한 업무 특성상  
  **비관적 락**이 더 적합하다고 판단
- **비관적 락(PESSIMISTIC_WRITE)을 적용하여  
  동시 접근 시 데이터 일관성/정합성을 보장하도록 개선**

---

## 6. 결론 및 향후 방안

동시성 이슈란
> **동일 자원에 여러 트랜잭션이 동시에 접근할 때  
> 데이터 정합성이 깨질 수 있는 위험**을 의미한다.

이 이슈가 실제로 발생하면
- 잔액, 재고, 쿠폰 등 **핵심 자원의 오류**
- **사용자 신뢰 저하**
- **비즈니스 장애/금전적 손실**  
  등 **심각한 사이드 이펙트**로 이어질 수 있다.

따라서
- **DB Lock(특히 비관적 락)**을 적극 활용해  
  데이터 정합성을 최우선으로 보장하는 구조로 개선하였으며,
- **향후에도 핵심 자원에 대한 동시성 이슈를 지속적으로 모니터링,  
  필요시 락 범위 조정, 성능 최적화 등**으로 시스템의 신뢰성과 안정성을 유지할 계획이다.

---

> **데이터 정합성 확보가 동시성 처리의 최우선 가치임을 재확인하며,  
> 비관적 락을 통해 이를 실현하였다.**

