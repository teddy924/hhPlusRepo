<pre><code># 주문/결제 API 시퀀스 다이어그램 (보유 쿠폰 할인 포함) ```mermaid sequenceDiagram actor Client participant API_Gateway as API Gateway participant Order_Service as Order Service participant Product_Service as Product Service participant Account_Service as Account Service participant Coupon_Service as Coupon Service participant DB participant External_Platform as 외부 플랫폼 Client->>API_Gateway: 주문 요청 (상품 목록 + 쿠폰 ID 포함) API_Gateway->>Order_Service: 주문 처리 요청 Order_Service->>Product_Service: 상품 가격/재고 확인 Product_Service-->>Order_Service: 상품 정보 반환 Order_Service->>Order_Service: 총 주문 금액 계산 alt 쿠폰 사용 Order_Service->>Coupon_Service: 쿠폰 유효성 및 할인 금액 확인 Coupon_Service-->>Order_Service: 할인 금액 반환 Order_Service->>Order_Service: 할인 적용된 최종 결제 금액 계산 end Order_Service->>Account_Service: 잔액 확인 및 차감 alt 잔액 부족 Account_Service-->>Order_Service: 잔액 부족 오류 Order_Service-->>API_Gateway: 결제 실패 응답 (잔액 부족) API_Gateway-->>Client: 결제 실패 else 잔액 충분 Account_Service-->>Order_Service: 차감 완료 Order_Service->>DB: 주문 및 결제 이력 저장 alt 쿠폰 사용 Order_Service->>Coupon_Service: 쿠폰 사용 처리 Coupon_Service->>DB: 쿠폰 사용 이력 저장 DB-->>Coupon_Service: 저장 완료 end DB-->>Order_Service: 저장 완료 loop 최대 5회 재시도 Order_Service->>External_Platform: 주문 데이터 전송 External_Platform-->>Order_Service: 전송 결과 (성공/실패) end alt 전송 성공 Order_Service-->>API_Gateway: 결제 성공 응답 API_Gateway-->>Client: 결제 완료 else 전송 실패 (5회 재시도 후) Order_Service->>DB: 주문/결제 롤백 DB-->>Order_Service: 롤백 완료 Order_Service-->>API_Gateway: 결제 실패 응답 (전송 실패) API_Gateway-->>Client: 결제 실패 end end ``` </code></pre>